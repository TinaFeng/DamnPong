
<html>
	<head>
       <meta charset="utf-8">
        <title>Pong</title>

        <style>

            #ip {
                text-align: center;
                line-height: 45px;
                vertical-align: middle;
                
            }
            

            #name {
                text-align: center;
                line-height: 45px;
                vertical-align: middle;
            }

            #log {
                width: 300px;
                height: 400px;
            }

            #Player {
                position: absolute; 
                top: 0; 
                right: 300px; 
                width: 100px; 
                text-align:right;
            }

            #Score {
                position: absolute;
                top: 25px;
                right: 300px;
                width: 100px;
                text-align: right;
            }

            canvas{
                position: absolute;
                margin:auto;
                top:0;
                bottom: 0;
                left:0;
                right: 0;
            }
        </style>
	</head>
    <body>
        Address:<input type="text" id="ip" name=" ip">
        <br />
        <br />
        Nickname: <input type="text" id="name" name="name">

        <input type="button" id="Play" name="Play" onclick="connect();" value="Play">
        <br />
        <br />
        <textarea id='log' name='log' readonly='readonly'></textarea><br />

        <p id="Player">Player</p>
        <br />
        <p id="Score">Score: 0</p>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
        <script src="fancywebsocket.js"></script>
        <script>
       
            //^ style thing to make it on the center;

            /// Client connection code from chat room
            var Server;

            var Connected = false;
            function log(text) {
                $log = $('#log');
                //Add text to log
                $log.append(($log.val() ? "\n" : '') + text);
                //Autoscroll
                $log[0].scrollTop = $log[0].scrollHeight - $log[0].clientHeight;
            }


            function send(text) {
                Server.send('message', text);
            }

            function connect() {

                if (document.getElementById('ip').value != ''&& document.getElementById('name').value != '') //if IP and name are not empty
                {
              

                    log('Connecting...');
                    Server = new FancyWebSocket('ws://' + document.getElementById('ip').value + ':' + 8000);

                    
                    //Let the user know we're connected
                    Server.bind('open', function () {
                        document.getElementById("Play").disabled = true;
                        log("Connected.");
                        Connected = true;
                        document.getElementById("Player").innerText = document.getElementById('name').value; //change the player text to name you just typed in
                    
                        main(); // don't start the game until connecteds
                        
                     
                    });

                    //OH NOES! Disconnection occurred.
                    Server.bind('close', function (data) {
                        document.getElementById("Play").disabled = false;
                        log("Disconnected.");
                    });

                    //Log any messages sent from server
                    Server.bind('message', function (payload) {
                        //log(payload);
                        if (payload.toString().length == 1) {

                            if (payload.toString() == "0") {
                                Player_Index = 1;
                       
                            }
                            else if (payload.toString() == "1") {
                                Player_Index = 2;
                            }
                            else if (payload.toString() == "2") {
                                Player_Index = 3;
                            }
                            else if (payload.toString() == "3") {
                                Player_Index = 4;
                            }
                        }
                        else {
                            
                            //if the server didn't send player location, it should be the states of the game, server_Location will split the states into
                            //individual object(ball, then player1, future players etc split by ";")
                            Server_Location = payload.split(";");
                        }
                    });

                    Server.connect();
                }
                else
                {
                    log("IP or Nickname cannot be empty.");
                }
      
            }

            //server stuff ^
            var WIDTH = 600, HEIGHT = 600, pi = Math.PI;
            var canvas, context, keystate;
            var player_T, ball;

            var speed = 10;
            //moving keys (only top)
            var LeftArrow = 37, RightArrow = 39;
            
            var score = 0;//score
            var Player_Index; // which player/color is the client, will be used to determine which section of server location is it
            var Server_Location; // all the location data the server is hosting. It is a string consist of xy locations of each object(separated by ;) 
            var Player_Location;// location that the player is drawing 
            var Ball_Location;//location of ball
            player_T = {
                x: null,
                y: null,
                width : 100,
                height :30,

                update: function () {
                    
       

                    if (Server_Location != null)
                    {

                        Player_Location = Server_Location[Player_Index].split(","); // spliting player1 x y
                
                        this.x = ~~Player_Location[1];  // YEAH INTEGER RIGHT
                        this.y = ~~Player_Location[0];
                        
                        if (this.score != ~~Player_Location[2])
                        {
                            this.score = ~~Player_Location[2];
                            document.getElementById('Score').innerHTML = "Score: " + this.score;
                        }

                    }
                    
                    
  
              
                    if (keystate[LeftArrow]) {
        
                  
                        send((Player_Index - 1).toString() + "2");
                    }
                    else if (keystate[RightArrow]) {
                
                        send((Player_Index - 1).toString() + "0");
                    }

           
                    //index will change depends on which side the paddle is
                },
                draw: function () {  //300,300;45,290
              
                    if (Player_Index == 1) {
                        context.fillStyle = 'red';
                    }
                    else if (Player_Index === 2) {
                        context.fillStyle = 'blue';
                    }
                    else if (Player_Index === 3) {
                        context.fillStyle = 'green';
                    }
                    else if (Player_Index === 4) {
                        context.fillStyle = 'yellow';
                    }
                    if (Server_Location != null) {
                        context.fillRect(Player_Location[1]-50, Player_Location[0], this.width, this.height);

                    }
                }
            };
          
            ball = {
                x: null,
                y: null,
                velocity: null,
                radius: 10,
                speed: 5,
                update: function () {

                    if (Server_Location != null)
                    {
                        Ball_Location = Server_Location[0].split(",");
                        this.x = ~~Ball_Location[0];
                        this.y = ~~Ball_Location[1];

                    }
              

                    //if (this.y <0 || this.y+this.radius > HEIGHT)
                    //{
      
                    //    this.velocity.y *= -1;

                    //}//if out of bound vertically, going back  //going to remove for actual game since no borders

                    //if (this.x < 0 || this.x + this.radius > WIDTH) //horizontal
                    //{
       
                    //    this.velocity.x *= -1;

                    //}


                    //var OnCollision = function (ax, ay, aw, ah, bx, by, bw, bh) {
                
                    //  //  log("ax - " + ax + " ay - " +ay +  " aw - " +aw +" ah - " +ah + " bx - " +bx+  " by- " +by+  " bw- " +bw +  " bh- " +bh );
                    //    if (Player_Index == 1)
                    //    {
           
                    //        //Top player:
                    //        //1:  (ball y - paddle y) <ball radius+paddle width
                    //        //2: bx+bw >ax  ball x is touching paddle x on the left
                    //        //3: bx-bw <ax+aw ball x is touching paddle x on the right

                  


                    //        return ((by - ay) < (bw + ah)) && ((bx + bw) > ax) && ((bx - bw) < (ax + aw));

                    //    }

                    //    /* 

                    //    The x position of the ball is greater than the x position of the brick.
                    //    The x position of the ball is less than the x position of the brick plus its width.
                    //    The y position of the ball is greater than the y position of the brick.
                    //    The y position of the ball is less than the y position of the brick plus its height.
                    //    */
              
                    //};

          
                    //if (OnCollision(player_T.x, player_T.y, player_T.width, player_T.height, // ADD ~~ TO CONVERT STRING BACK TO INT GODS DAMN IT JS
                    //        this.x, this.y, this.radius, this.radius)) //if ball collided with paddle
                    //{

                    //    if (Player_Index == 1) {

                    //        var hit_location = this.x+ this.radius/2;
                    //  //      log(hit_location);

                    //        if (hit_location < player_T.x + player_T.width / 2) // if hit is on the left of paddle
                    //        {
                          
                    //            this.velocity.y *= -1;
                    //            this.velocity.x = -5;

                    //        }
                    //            else if ((hit_location > player_T.x + player_T.width / 2)) //if hits on the right of paddle
                    //            {
                    //                this.velocity.y *= -1;
                    //                this.velocity.x = 5;
                    //            }


                    //            else // if hits on center
                    //            {
                          
                    //                this.velocity.y *= -1;
                    //                this.velocity.x *= -1;
                    //            }
                    //    }

                    //    score++;
                    //    document.getElementById("Score").innerText = "Score: " + score;

                    //};


                },


                draw: function () {
                    context.fillRect(this.x, this.y, this.radius, this.radius);
                }

            };


            function main() {

             
                //create the canvas
                canvas = document.createElement("canvas");
                canvas.width = WIDTH;
                canvas.height = HEIGHT;
                context = canvas.getContext("2d");
                document.body.appendChild(canvas);


            
                keystate = {};
                document.addEventListener("keydown", function (evt) {
                    keystate[evt.keyCode] = true;

                });
                document.addEventListener("keyup", function (evt) {
                    delete keystate[evt.keyCode];
                });
             
                init();

             
                var loop = function () {
           
                    update();
          
                    draw();


                    window.requestAnimationFrame(loop, canvas);
                };
                window.requestAnimationFrame(loop, canvas);
   
            }

            function init() { //on start
              
                if (Player_Index == 1)
                {
                    player_T.x =45;
                    player_T.y = 300;

                }


                ball.x = 300;
                ball.y = 300;

       
            }


            function update() {
   
                player_T.update();
  
                ball.update();
     
            }
            function draw() {

                //background size and color
                context.fillRect(0, 0, WIDTH, HEIGHT);
                context.save();
                context.fillStyle = "#fff";

                //objects
                ball.draw();
                player_T.draw();
            //    player_B.draw();
                context.restore();
            }

            
         
        </script>
    </body>
</html>
